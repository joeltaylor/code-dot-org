#!/usr/bin/env ruby

# This script changes any 'on' values for the volunteer_after_hoc_b field for
# VolunteerEngineerSubmission2015 form submissions to '1'. These were recorded
# as 'on' by error.

require File.expand_path('../../../pegasus/src/env', __FILE__)
require 'digest/md5'
require src_dir 'database'

DB[:forms].where(kind: 'VolunteerEngineerSubmission2015').each do |volunteer|
  data = JSON.parse(volunteer[:data])
  if data['volunteer_after_hoc_b'] = 'on'
    puts "Fixing ID: #{volunteer[:id]}..."

    # Delete the existing SOLR entry, so reindexing doesn't create duplicates.
    SOLR.delete_by_id volunteer[:id]

    # Fix the DB by updating the field, resetting indexed_at so the form gets
    # reindexed.
    data['volunteer_after_hoc_b'] = '1'
    volunteer.update(data: data.to_json, indexed_at: nil)
  end
end
